(function() {
    var testData = {"name":"andy_needs_a_nap","date":"2018-09-27T20:59:44.434Z","start":"2018-09-27T20:59:44.434Z","stop":"2018-09-27T21:14:33.385Z","levels":[{"level":"Level_27","speed":350,"gameType":"continuous","av":"visual","startTime":"2018-09-27T21:14:03.387Z","stopTime":"2018-09-27T21:14:33.385Z","collisionData":[{"id":"none","collisionRecord":{"duringBeat":1,"collisionTime":1750},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":2,"collisionTime":2100},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":3,"collisionTime":2450},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":4,"collisionTime":2800},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":5,"collisionTime":3016.1080004181713},"latency":"134","time":1538082846391},{"id":"Mouse_Press","collisionRecord":{"duringBeat":6,"collisionTime":3649.476999649778},"latency":"149","time":1538082847037},{"id":"none","collisionRecord":{"duringBeat":7,"collisionTime":3850},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":8,"collisionTime":4200},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":9,"collisionTime":4550},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":10,"collisionTime":4900},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":11,"collisionTime":5250},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":12,"collisionTime":5482.806004118174},"latency":"117","time":1538082848862},{"id":"none","collisionRecord":{"duringBeat":13,"collisionTime":5950},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":14,"collisionTime":6182.716010807781},"latency":"117","time":1538082849569},{"id":"none","collisionRecord":{"duringBeat":15,"collisionTime":6650},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":16,"collisionTime":7000},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":17,"collisionTime":7350},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":18,"collisionTime":7700},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":19,"collisionTime":8099.0020150493365},"latency":"49","time":1538082851488},{"id":"none","collisionRecord":{"duringBeat":20,"collisionTime":8400},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":21,"collisionTime":8716.879012266872},"latency":"33","time":1538082852104},{"id":"none","collisionRecord":{"duringBeat":22,"collisionTime":9100},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":23,"collisionTime":9400.026014744071},"latency":"50","time":1538082852772},{"id":"none","collisionRecord":{"duringBeat":24,"collisionTime":9800},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":25,"collisionTime":10150},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":26,"collisionTime":10500},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":27,"collisionTime":10850},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":28,"collisionTime":11349.663022177992},"latency":"150","time":1538082854737},{"id":"none","collisionRecord":{"duringBeat":29,"collisionTime":11550},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":30,"collisionTime":12033.49002377945},"latency":"133","time":1538082855408},{"id":"none","collisionRecord":{"duringBeat":31,"collisionTime":12250},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":32,"collisionTime":12600},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":33,"collisionTime":12950},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":34,"collisionTime":13300},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":35,"collisionTime":13682.057023252128},"latency":"32","time":1538082857069},{"id":"none","collisionRecord":{"duringBeat":36,"collisionTime":14000},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":37,"collisionTime":14332.917019666638},"latency":"17","time":1538082857704},{"id":"none","collisionRecord":{"duringBeat":38,"collisionTime":14700},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":39,"collisionTime":15008.692016766872},"latency":"41","time":1538082858386},{"id":"none","collisionRecord":{"duringBeat":40,"collisionTime":15400},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":41,"collisionTime":15750},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":42,"collisionTime":16100},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":43,"collisionTime":16450},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":44,"collisionTime":16928.957017546054},"latency":"129","time":1538082860325},{"id":"none","collisionRecord":{"duringBeat":45,"collisionTime":17150},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":46,"collisionTime":17566.25801831251},"latency":"66","time":1538082860943},{"id":"none","collisionRecord":{"duringBeat":47,"collisionTime":17850},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":48,"collisionTime":18200},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":49,"collisionTime":18550},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":50,"collisionTime":18900},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":51,"collisionTime":19250},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":52,"collisionTime":19433.407009171788},"latency":"167","time":1538082862809},{"id":"Mouse_Press","collisionRecord":{"duringBeat":53,"collisionTime":20099.454005772714},"latency":"149","time":1538082863472},{"id":"none","collisionRecord":{"duringBeat":54,"collisionTime":20300},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":55,"collisionTime":20650},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":56,"collisionTime":21000},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":57,"collisionTime":21350},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":58,"collisionTime":21700},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":59,"collisionTime":22050},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":60,"collisionTime":22566.26801675884},"latency":"166","time":1538082865946},{"id":"none","collisionRecord":{"duringBeat":61,"collisionTime":22750},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":62,"collisionTime":23233.357017103117},"latency":"133","time":1538082866610},{"id":"none","collisionRecord":{"duringBeat":63,"collisionTime":23450},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":64,"collisionTime":23800},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":65,"collisionTime":24150},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":66,"collisionTime":24500},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":67,"collisionTime":24850},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":68,"collisionTime":25133.61501408508},"latency":"66","time":1538082868511},{"id":"none","collisionRecord":{"duringBeat":69,"collisionTime":25550},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":70,"collisionTime":25799.957018287387},"latency":"100","time":1538082869186},{"id":"none","collisionRecord":{"duringBeat":71,"collisionTime":26250},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":72,"collisionTime":26600},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":73,"collisionTime":26950},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":74,"collisionTime":27300},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":75,"collisionTime":27650},"latency":-1},{"id":"none","collisionRecord":{"duringBeat":76,"collisionTime":28000},"latency":-1},{"id":"Mouse_Press","collisionRecord":{"duringBeat":77,"collisionTime":28232.79901064234},"latency":"117","time":1538082871605},{"id":"Mouse_Press","collisionRecord":{"duringBeat":78,"collisionTime":28749.328009143937},"latency":"49","time":1538082872124}],"averageLatency":"98.36"}]}

    "use strict";
    
    var EVENT_BRIDGE_OPEN_MESSAGE = "eventBridgeOpen",
        UPDATE_UI = "update_ui",
        SAVE_JSON = "saveJSON",
        UPDATE_PLAYER_NAME = "update_player_name",
        RESTART_GAME = "restart_game",
        STOP_GAME = "stop_game",
        EVENTBRIDGE_SETUP_DELAY = 50;

    Vue.component('instructions', {
        template:`
            <div class="card">
                <div class="card-body">
                    <p>To interact with the game, grab the drum sticks and hit the drum pad with the spherical drumstick hit.  
                        You will be presented with 27 levels where you must hit the drum pad to the beat. The different levels are a combination of the following configurations:</p>
                    <p>
                        Speed:
                        <ul>
                        <li>Slow</li>
                        <li>Medium</li>
                        <li>Fast</li>
                        </ul>
                    </p>
                    <p>
                        Audio-Visual Cues indicating where the beat is: 
                        <ul>
                        <li>Audio</li>
                        <li>Video</li>
                        <li>AudioVideo</li>
                        </ul>
                    </p>
                    <p>
                        Game Type:
                        <ul>
                        <li>On - Hit the pad on the beat when the ball hits the edge of a wall</li>
                        <li>Off - Hit the pad on syncopated eight note off beat when the ball is in the middle</li>
                        <li>Continuous - First listen to the beat with a cue, and then play it back without the cue where you think the ball hit a wall</li>
                        </ul>
                    </p>
                </div>
            </div>
        `
    })

    Vue.component('restart-game', {
        methods: {
            restartGame(){
                EventBridge.emitWebEvent(JSON.stringify({
                    type: RESTART_GAME
                }));
            }
        },
        template:`
            <div class="card">
                <div class="card-body">
                    <button class="btn-sm btn-primary mt-1 mr-1" v-on:click="restartGame()">Restart Game</button>
                </div>
            </div>
        `
    })

    Vue.component('stop-game', {
        methods: {
            stopGame(){
                EventBridge.emitWebEvent(JSON.stringify({
                    type: STOP_GAME
                }));
            }
        },
        template:`
            <div class="card">
                <div class="card-body">
                    <button class="btn-sm btn-primary mt-1 mr-1" v-on:click="stopGame()">Stop Game</button>
                </div>
            </div>
        `
    })

    Vue.component('enter-player-name', {
        data: function(){
            return {
                newPlayerName: "",
                editing: false,
                editingJSONURL: false,
            }
        },
        methods: {
            updateName(name){
                this.editing = false;
                EventBridge.emitWebEvent(JSON.stringify({
                    type: UPDATE_PLAYER_NAME,
                    value: name
                }));
                this.newPlayerName = "";
            }
        },
        template:`
            <div class="card">
                <div class="card-body">
                        Please Enter Your Name
                        <input id="enter-player-name" type="text" class="form-control" v-model="newPlayerName">
                        <button class="btn-sm btn-primary mt-1 mr-1" v-on:click="updateName(newPlayerName)">Save Player Name</button>
                </div>
            </div>
        `
    })

    Vue.component('show-message', {
        props: ["message"],
        methods: {
            updateName(name){
                this.editing = false;
                EventBridge.emitWebEvent(JSON.stringify({
                    type: UPDATE_PLAYER_NAME,
                    value: name
                }));
                this.newPlayerName = "";
            }
        },
        computed: {
            formatedMessage() {
                // console.log("FORMATTED MESSAGES")
                var newMessage = JSON.stringify(this.message)
                .replace(/\\n/g, "<br>")
                .replace(/\"/g, "")
                .replace(/\\t/g, "    ")
                .split(",").join("<br>\   ")
                .split("{").join("")
                .split("}").join("<br>").replace(/"/g,"");
                return newMessage;
            }
        },
        template:`
            <div class="card">
                <div class="card-body" v-html="formatedMessage">
                        {{formatedMessage}}
                </div>
            </div>
        `
    })

    var app = new Vue({
        el: '#app',
        data: {
            settings: {
                playerName: "",
                gameRunning: false,
                message: null,
                gameData: null,
                ui: {
                    enterPlayerName: true,
                    showMessage: true,
                    gameRunning: false,
                    gameEnding: false
                }
            }
        }
    });

    var test = {
        array: {
            test: [],
            test: ["1", 2]
        }
    }

    function removeEmpty(obj) {
        Object.keys(obj).forEach(function(key) {
            (obj[key] && Array.isArray(obj[key])) && obj[key].forEach(function(item){removeEmpty(item)}) ||
            (obj[key] && typeof obj[key] === 'object') && removeEmpty(obj[key]) ||
            (obj[key] === '' || obj[key] === null || obj[key].length === 0) && delete obj[key]
        });
        return obj;
    };

    window.googleDocCallback = function () { return true; };

    function saveJSON(gameData){
        console.log("in save json from tablet")
        var gameDataBase = Object.assign({}, gameData),
            levels = gameDataBase.levels,
            // POST_URL = "https://neuroscape.glitch.me/json/";
            POST_URL = "https://script.google.com/macros/s/AKfycbw3eTFCHogekvkQsMIJj4-NmbfDsglb_Md81AQaH8iNP0qghzdR/exec";
            
            console.log("Making Post / get request");
            $.get(POST_URL, gameData, function(data){
                console.log("### POST TEST: Data Returned: " + data)
            })
                .done(function(){
                    console.log("### POST TEST: finished on success")
                })
                .fail(function(){
                    console.log("### POST TEST: finished on FAIL")
                })
                .always(function(){
                    console.log("### POST TEST: ALL FINISHED")
                })
        // if (levels.length < 3) {
        //     $.post(POST_URL, gameData);
        // } else {
        //     var splitAmount = Math.ceil(levels.length / 4),
        //         levels_part1 = levels.slice(0, splitAmount),
        //         levels_part2 = levels.slice(splitAmount, splitAmount * 2),
        //         levels_part3 = levels.slice(splitAmount * 2, splitAmount * 3),
        //         levels_part4 = levels.slice(splitAmount * 3, levels.length - 1),
        //         gameData_part1 = Object.assign({}, gameData, {playerName: gameData.playerName + "_" + "part1", part: 1, levelsData: levels_part1}),
        //         gameData_part2 = Object.assign({}, gameData, {playerName: gameData.playerName + "_" + "part2", part: 2, levelsData: levels_part2}),
        //         gameData_part3 = Object.assign({}, gameData, {playerName: gameData.playerName + "_" + "part3", part: 3, levelsData: levels_part3});
        //         gameData_part4 = Object.assign({}, gameData, {playerName: gameData.playerName + "_" + "part4", part: 4, levelsData: levels_part4});
            
        //     $.post(POST_URL, gameData_part1);
        //     $.post(POST_URL, gameData_part2);
        //     $.post(POST_URL, gameData_part3);
        //     $.post(POST_URL, gameData_part4);

        // }
        
    }

    function onScriptEventReceived(message) {
        var data;
        try {
            data = JSON.parse(message);
            switch (data.type) {
                case UPDATE_UI:
                    app.settings = data.value;
                    break;
                case SAVE_JSON:
                    console.log("$$$ save json")
                    saveJSON(data.value);
                    break;
                default:
            }
        } catch (e) {
            console.log(e)
            return;
        }
    }
    
    function onLoad() {
        
        // Initial button active state is communicated via URL parameter.
        // isActive = location.search.replace("?active=", "") === "true";

        setTimeout(function () {
            // Open the EventBridge to communicate with the main script.
            // Allow time for EventBridge to become ready.
            EventBridge.scriptEventReceived.connect(onScriptEventReceived);
            EventBridge.emitWebEvent(JSON.stringify({
                type: EVENT_BRIDGE_OPEN_MESSAGE
            }));
            console.log("sending test data")
            saveJSON(testData)
        }, EVENTBRIDGE_SETUP_DELAY);
    }

    onLoad();

}());
